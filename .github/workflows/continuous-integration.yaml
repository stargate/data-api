# @author Ivan Senic
name: Continuous Integration

# runs on
# * pushes and pull requests on the "main" (pull request only for specific paths)
# * manual trigger
on:
  push:
    branches: [ "main", "feature/*" ]

  pull_request:
    branches: [ "main", "feature/*" ]

  workflow_dispatch:

# cancel same workflows in progress for pull request branches
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}


# global env vars, available in all jobs and steps
env:
  MAVEN_OPTS: '-Xmx4g'
  DS_ARTIFACTORY_USERNAME: ${{ secrets.DS_ARTIFACTORY_USERNAME }}
  DS_ARTIFACTORY_PASSWORD: ${{ secrets.DS_ARTIFACTORY_PASSWORD }}

# Jobs structure:
#
# 1. Runs unit tests
# 2. Then 2 jobs in parallel
#  a) Integration tests with DSE 6.9
#  b) Integration tests with HCD
jobs:

  # runs unit tests
  build:
    name: Unit tests
    runs-on: ubuntu-latest

    # max run time 12 minutes
    timeout-minutes: 12

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: Setup Maven
        run: |
          mkdir -p ~/.m2
          cat <<EOF > ~/.m2/settings.xml
          <settings>
            <servers>
              <server>
                <id>stargate-central</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
              </server>
              <server>
                <id>stargate-snapshots</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
             </server>
              <server>
                <id>artifactory</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
              </server>
              <server>
                <id>artifactory-snapshots</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
              </server>
              <server>
                <id>artifactory-releases</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
             </server>
           </servers>
          </settings>
          EOF

      - name: Build & Test
        run: |
          ./mvnw -B -ntp clean test

      # Publish baseline coverage for main branch (for future PR comparisons)
      - name: Publish baseline coverage
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v5
        with:
          name: baseline-coverage
          path: target/site/jacoco/jacoco.xml
          retention-days: 30

      # Download baseline coverage from main branch for PR comparison
      - name: Download baseline coverage
        if: github.event_name == 'pull_request'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get recent successful runs on main and find one with the baseline-coverage artifact
          echo "Searching for a workflow run with baseline-coverage artifact..."
          for run_id in $(gh run list --workflow=continuous-integration.yaml --branch=main --status=success --limit=10 --json databaseId --jq='.[].databaseId'); do
            echo "Checking run $run_id for baseline-coverage artifact..."
            if gh run download $run_id --name baseline-coverage --dir baseline-coverage 2>/dev/null; then
              echo "‚úÖ Successfully downloaded baseline coverage from run $run_id"
              exit 0
            fi
          done
          echo "‚ö†Ô∏è  No baseline coverage artifact found in recent runs (this is expected on first PR after coverage setup)"

      - name: Calculate and report coverage delta
        if: github.event_name == 'pull_request'
        id: coverage-delta
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import os
          import json
          import urllib.request

          def get_coverage(xml_file):
              if not os.path.exists(xml_file):
                  return 0
              try:
                  tree = ET.parse(xml_file)
                  counters = tree.findall('.//counter[@type="INSTRUCTION"]')
                  covered = sum(int(c.get('covered', 0)) for c in counters)
                  missed = sum(int(c.get('missed', 0)) for c in counters)
                  total = covered + missed
                  return (covered / total * 100) if total > 0 else 0
              except:
                  return 0

          def github_api(method, endpoint, data=None):
              url = f"https://api.github.com/repos/{os.environ['REPO']}/{endpoint}"
              headers = {
                  'Authorization': f"token {os.environ['GH_TOKEN']}",
                  'Accept': 'application/vnd.github.v3+json'
              }
              req = urllib.request.Request(url, headers=headers, method=method)
              if data:
                  req.data = json.dumps(data).encode()
              return json.loads(urllib.request.urlopen(req).read())

          current = get_coverage('target/site/jacoco/jacoco.xml')
          baseline = get_coverage('baseline-coverage/jacoco.xml')
          has_baseline = os.path.exists('baseline-coverage/jacoco.xml')

          # Write outputs for job summary
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'current_coverage={current:.2f}\n')
              if has_baseline:
                  delta = current - baseline
                  f.write(f'baseline_coverage={baseline:.2f}\n')
                  f.write(f'delta={delta:.2f}\n')
                  f.write(f'has_baseline=true\n')
                  print(f'Coverage: {baseline:.2f}% (main) ‚Üí {current:.2f}% (PR) = {delta:+.2f}%')

                  # Post PR comment with delta
                  emoji = 'üìà' if delta > 0 else 'üìâ' if delta < 0 else '‚û°Ô∏è'
                  color = 'üü¢' if delta > 0 else 'üî¥' if delta < 0 else '‚ö™'
                  sign = '+' if delta > 0 else ''
                  msg = '‚ö†Ô∏è Coverage decreased' if delta < 0 else '‚úÖ Coverage improved!' if delta > 0 else '‚ÑπÔ∏è Coverage unchanged'

                  comment_body = f"""
## {emoji} Coverage Delta vs Main Branch

| Metric | Value |
|--------|-------|
| **Main Branch** | {baseline:.2f}% |
| **This PR** | {current:.2f}% |
| **Delta** | {color} {sign}{delta:.2f}% |
{msg}
"""

                  # Find and update existing comment or create new one
                  pr_number = os.environ['PR_NUMBER']
                  comments = github_api('GET', f'issues/{pr_number}/comments')
                  existing = next((c for c in comments if c.get('user', {}).get('login') == 'github-actions[bot]'
                                   and 'Coverage Delta vs Main Branch' in c.get('body', '')), None)

                  if existing:
                      github_api('PATCH', f"issues/comments/{existing['id']}", {'body': comment_body})
                      print(f'Updated comment {existing["id"]}')
                  else:
                      github_api('POST', f'issues/{pr_number}/comments', {'body': comment_body})
                      print('Created new comment')
              else:
                  f.write(f'has_baseline=false\n')
                  print('‚ö†Ô∏è  No baseline coverage (expected on first PR after setup)')
          EOF

      - name: Add coverage to PR
        id: jacoco
        uses: madrapps/jacoco-report@v1.7.2
        if: github.event_name == 'pull_request'
        with:
          paths: |
            ${{ github.workspace }}/target/site/jacoco/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 40
          min-coverage-changed-files: 60
          title: 'Code Coverage Report'
          update-comment: true

      - name: Generate JaCoCo Badge
        id: jacoco-badge
        uses: cicirello/jacoco-badge-generator@v2
        with:
          badges-directory: .github/badges
          generate-branches-badge: true
          generate-summary: true

      - name: Add coverage to Job Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üìä Code Coverage Report

          | Metric | Coverage |
          |--------|----------|
          | **Instructions** | ${{ steps.jacoco-badge.outputs.coverage }}% |
          | **Branches** | ${{ steps.jacoco-badge.outputs.branches }}% |
          EOF

          # Add delta for PRs with baseline
          if [ "${{ github.event_name }}" == "pull_request" ] && [ "${{ steps.coverage-delta.outputs.has_baseline }}" == "true" ]; then
            delta="${{ steps.coverage-delta.outputs.delta }}"
            cat >> $GITHUB_STEP_SUMMARY << EOF

          ### Coverage vs Main: ${{ steps.coverage-delta.outputs.baseline_coverage }}% ‚Üí ${{ steps.coverage-delta.outputs.current_coverage }}% (${delta}%)
          EOF
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF

          _Baseline coverage will be available after first merge to main_
          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF

          üì• [Download Full HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

      - name: Upload JaCoCo coverage report
        uses: actions/upload-artifact@v5
        with:
          name: jacoco-report
          path: target/site/jacoco/
  

  # runs int tests
  int-tests:
    name: Integration tests
    runs-on: ubuntu-latest

    # max run time 40 minutes
    timeout-minutes: 40

    strategy:

      # let all tests run, can find multiple failures in different setup
      fail-fast: false

      # matrix props:
      matrix:
        type: [ docker, dse69-it, hcd-it ]
        include:
          - type: dse69-it
            profile: '-Pdse69-it'
          - type: hcd-it
            profile: '-Phcd-it'
        exclude:
          - type: docker

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: Setup Maven
        run: |
          mkdir -p ~/.m2
          cat <<EOF > ~/.m2/settings.xml
          <settings>
            <servers>
              <server>
                <id>stargate-central</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
              </server>
              <server>
                <id>stargate-snapshots</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
             </server>
              <server>
                <id>artifactory</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
              </server>
              <server>
                <id>artifactory-snapshots</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
              </server>
              <server>
                <id>artifactory-releases</id>
                <username>${DS_ARTIFACTORY_USERNAME}</username>
                <password>${DS_ARTIFACTORY_PASSWORD}</password>
             </server>
           </servers>
          </settings>
          EOF

      # login to ECR to we can pull HCD image.
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.HCD_ECR_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.HCD_ECR_SECRET_KEY }}
          aws-region: us-west-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: 'true'

      # run the int tests
      - name: Integration Test
        # -DRERANKING_CONFIG_RESOURCE=test-reranking-providers-config.yaml is to override the reranking config to customized one
        # -DEMBEDDING_CONFIG_RESOURCE=test-embedding-providers-config.yaml is to override the embedding config to customized one
        run: |
          ./mvnw -B -ntp clean verify -DskipUnitTests -DRERANKING_CONFIG_RESOURCE=test-reranking-providers-config.yaml -DEMBEDDING_CONFIG_RESOURCE=test-embedding-providers-config.yaml -Dquarkus.container-image.build=true -Dquarkus.container-image.tag=${{ github.sha }} -Drun-create-index-parallel=true ${{ matrix.profile }}